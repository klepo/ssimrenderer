<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SSIMRenderer: IntensityShapeModel.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SSIMRenderer
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Statistical Shape and Intensity Models GPU-Accelerated Renderer Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">IntensityShapeModel.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example shows how to render virtual X-Ray images from shape and intensity model. The SSIM is loaded from two MATLAB files containing matrices of PCA-based models that describe bone shape and densities and one Mesh file storing tetrahedral model of a bone. In addition to the rendering it is also shown how to export surface (full or truncated) of the shape model to the STL file format. For further details about initializing the application and setting the project file up please have a look at the example called "SimpleStatismoModel".</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;QApplication&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QDebug&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="ssimrenderer_8h.html">ssimrenderer.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a0"></a><a class="code" href="_intensity_shape_model_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <span class="comment">// Initialization of Qt-based application, QCoreApplication is not sufficient.</span></div><div class="line">    QApplication a(argc, argv);</div><div class="line">    Q_UNUSED(a);</div><div class="line"></div><div class="line">    <span class="comment">// Initialization of the offscreen renderer.</span></div><div class="line">    <a name="_a1"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html">SSIMRenderer::OffscreenRenderer</a> *renderer = <span class="keyword">new</span> <a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html">SSIMRenderer::OffscreenRenderer</a>(1024, 1024);</div><div class="line"></div><div class="line">    <span class="comment">// Input file for tetrahedral mesh in Lm6 Mesh format.</span></div><div class="line">    <a name="_a2"></a><a class="code" href="class_s_s_i_m_renderer_1_1_lm6_mesh_file.html">SSIMRenderer::Lm6MeshFile</a> *meshFile = 0;</div><div class="line">    <span class="comment">// Input file for PCA-based shape model corresponding to the previous tetrahedral mesh.</span></div><div class="line">    <span class="comment">// The shape model is stored in a custom format as a set of MATLAB matrices.</span></div><div class="line">    <a name="_a3"></a><a class="code" href="class_s_s_i_m_renderer_1_1_mat_statistical_data_file.html">SSIMRenderer::MatStatisticalDataFile</a> *shapeFile = 0;</div><div class="line">    <span class="comment">// Input file for PCA-based model of bone densities. The bone densities are described</span></div><div class="line">    <span class="comment">// within each tetrahedron using Bernstain polynomials of certain degree (typically 0-3).</span></div><div class="line">    <a class="code" href="class_s_s_i_m_renderer_1_1_mat_statistical_data_file.html">SSIMRenderer::MatStatisticalDataFile</a> *densityFile = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        <span class="comment">// The Lm6 model contains tetrahedral and even polygonal meshes.</span></div><div class="line">        <span class="comment">// Thanks to that it is possible to render virtual X-Ray images,</span></div><div class="line">        <span class="comment">// surfaces and even silhouettes from the shape model.</span></div><div class="line"></div><div class="line">        <span class="comment">// Loads the tetrahedral model.</span></div><div class="line">        meshFile    = <span class="keyword">new</span> <a class="code" href="class_s_s_i_m_renderer_1_1_lm6_mesh_file.html">SSIMRenderer::Lm6MeshFile</a>(DATA_PATH <span class="stringliteral">&quot;/model.mesh&quot;</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Loads the shape model.</span></div><div class="line">        shapeFile   = <span class="keyword">new</span> <a class="code" href="class_s_s_i_m_renderer_1_1_mat_statistical_data_file.html">SSIMRenderer::MatStatisticalDataFile</a>(DATA_PATH <span class="stringliteral">&quot;/shape.mat&quot;</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Loads the model describing bone densities.</span></div><div class="line">        densityFile = <span class="keyword">new</span> <a class="code" href="class_s_s_i_m_renderer_1_1_mat_statistical_data_file.html">SSIMRenderer::MatStatisticalDataFile</a>(DATA_PATH <span class="stringliteral">&quot;/density.b3.mat&quot;</span>);</div><div class="line"></div><div class="line">    } <span class="keywordflow">catch</span> (std::exception &amp;e) {</div><div class="line">        <span class="comment">// Wrong file</span></div><div class="line">        qFatal(e.what());</div><div class="line">        exit(EXIT_FAILURE);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Sets the tetrahedral and statistical models to the renderer.</span></div><div class="line">    renderer-&gt;<a name="a4"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a671f9488620b888ec548883ee795b8d9">setMesh</a>(meshFile);</div><div class="line">    renderer-&gt;<a name="a5"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a535823451ea845503d2e277b47525722">setVertices</a>(shapeFile);</div><div class="line">    renderer-&gt;<a name="a6"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a0ff9cedc4539977211957a00da36e751">setCoefficients</a>(densityFile);</div><div class="line"></div><div class="line">    <span class="comment">// Setting up the renderer to render the virtual X-Ray images.</span></div><div class="line">    renderer-&gt;<a name="a7"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a996774c957af4f5f022f5d5f33acfc52">enableSilhouettes</a>(<span class="keyword">false</span>);</div><div class="line">    renderer-&gt;<a name="a8"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a404234615f5773f37f00a2ab9eb1c76d">enableDensity</a>(<span class="keyword">true</span>);</div><div class="line">    renderer-&gt;<a name="a9"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#ae859ec2b93d7b7f85e2182eb8ee45b15">enablePyramid</a>(<span class="keyword">true</span>);</div><div class="line">    renderer-&gt;<a name="a10"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#ac126d47257d2f69a2aeaef90f30ce0d5">enablePolygonal</a>(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Initialization of the perspective.</span></div><div class="line">    QVector3D eye(        102.8380004f,  551.2176983f, -430.5f);</div><div class="line">    QVector3D leftTop(   -408.6619996f, -448.7823017f, -942.f);</div><div class="line">    QVector3D leftBottom(-408.6619996f, -448.7823017f,   81.f);</div><div class="line">    QVector3D rightTop(   614.3380004f, -448.7823017f, -942.f);</div><div class="line">    QVector3D rightBottom(614.3380004f, -448.7823017f,   81.f);</div><div class="line">    <a name="_a11"></a><a class="code" href="class_s_s_i_m_renderer_1_1_pyramid.html">SSIMRenderer::Pyramid</a> pyramid(leftTop, leftBottom, rightTop, rightBottom, eye);</div><div class="line"></div><div class="line">    <span class="comment">// Sets the perspective to the renderer.</span></div><div class="line">    renderer-&gt;<a name="a12"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a4c3a427647216e29441d53f0c84e1977">setPerspective</a>(pyramid);</div><div class="line"></div><div class="line">    <span class="comment">// Sets some particular shape parameters.</span></div><div class="line">    shapeFile-&gt;<a name="a13"></a><a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(0,  500);</div><div class="line">    shapeFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(1, -500);</div><div class="line">    shapeFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(2,  250);</div><div class="line"></div><div class="line">    renderer-&gt;<a name="a14"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a3a07a4cd221c4d269b659fa7661c780f">updateVertices</a>(shapeFile);</div><div class="line"></div><div class="line">    <span class="comment">// Sets pose of the shape model.</span></div><div class="line">    renderer-&gt;<a name="a15"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a327d040d09538dd27d818d624efe4eb3">setRotation</a>(1.4756f, 3.0457f, 30.784f);</div><div class="line">    renderer-&gt;<a name="a16"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a2befb45d965bd62396f6d6f8e73f0b4b">setTranslation</a>(111.81f, 47.057f, -437.07f);</div><div class="line"></div><div class="line">    renderer-&gt;<a name="a17"></a><a class="code" href="class_s_s_i_m_renderer_1_1_open_g_l_wrapper.html#a2bc73ded7650da546f699260e6d18a63">renderNow</a>();</div><div class="line"></div><div class="line">    <span class="comment">// Sets some particular density parameters.</span></div><div class="line">    densityFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(0, -98299);</div><div class="line">    densityFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(1, 73185);</div><div class="line">    densityFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(2, -300138);</div><div class="line">    densityFile-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_statistical_data.html#ae67d7a880be195d7e45f4c0a40ee0536">updatePcsMatrix</a>(3, -125250);</div><div class="line"></div><div class="line">    renderer-&gt;<a name="a18"></a><a class="code" href="class_s_s_i_m_renderer_1_1_offscreen_renderer.html#a2eebd78a3cc8dba596745dd407ce7156">updateCoefficients</a>(densityFile);</div><div class="line"></div><div class="line">    renderer-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_open_g_l_wrapper.html#a2bc73ded7650da546f699260e6d18a63">renderNow</a>();</div><div class="line">    renderer-&gt;<a name="a19"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a381845be300640e796a2689d9153cf55">saveRenderedImage</a>(DATA_PATH <span class="stringliteral">&quot;/drr.png&quot;</span>);</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;Digitally reconstructed radiograph saved to &quot;</span> DATA_PATH <span class="stringliteral">&quot;/drr.png&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Exports the surface of the shape model as a STL file.</span></div><div class="line">    renderer-&gt;<a name="a20"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a45cf932543a0c983efa4049065f77ce3">exportSTL</a>(DATA_PATH <span class="stringliteral">&quot;/surface.stl&quot;</span>);</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;Polygonal model saved to &quot;</span> DATA_PATH <span class="stringliteral">&quot;/surface.stl&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Sets a new pose of the shape model, so only a promixal femur is visible</span></div><div class="line">    <span class="comment">// in the rendered X-Ray image.</span></div><div class="line">    renderer-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a2befb45d965bd62396f6d6f8e73f0b4b">setTranslation</a>(111.81f, 47.057f, -637.07f);</div><div class="line">    renderer-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_open_g_l_wrapper.html#a2bc73ded7650da546f699260e6d18a63">renderNow</a>();</div><div class="line"></div><div class="line">    renderer-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a381845be300640e796a2689d9153cf55">saveRenderedImage</a>(DATA_PATH <span class="stringliteral">&quot;/drr_truncated.png&quot;</span>);</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;Truncated digitally reconstructed radiograph saved to &quot;</span> DATA_PATH <span class="stringliteral">&quot;/drr_truncated.png&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Exports only the part of the shape model surface that is visible in the</span></div><div class="line">    <span class="comment">// rendered X-Ray image. The truncated surface is stored in STL file format.</span></div><div class="line">    <span class="keywordtype">int</span> vn = meshFile-&gt;<a name="a21"></a><a class="code" href="class_s_s_i_m_renderer_1_1_mesh.html#a053ddc6c9f82453869e109b191ad3fc7">getNumberOfVertices</a>();</div><div class="line">    <span class="keywordtype">float</span> *v = <span class="keyword">new</span> <span class="keywordtype">float</span>[vn * 3]();</div><div class="line">    renderer-&gt;<a name="a22"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a4bd5deeb6d55857c618a64d51f3098ff">getRecomputedVertices</a>(v);</div><div class="line">    QVector&lt;bool&gt; mask = renderer-&gt;<a name="a23"></a><a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a022ce11a795c635dfad088841187eaa2">getVerticesMask</a>(v, vn);</div><div class="line">    renderer-&gt;<a class="code" href="class_s_s_i_m_renderer_1_1_main_renderer.html#a45cf932543a0c983efa4049065f77ce3">exportSTL</a>(DATA_PATH <span class="stringliteral">&quot;/truncated.stl&quot;</span>, <span class="keyword">true</span>, mask);</div><div class="line">    qDebug() &lt;&lt; <span class="stringliteral">&quot;Truncated polygonal model saved to &quot;</span> DATA_PATH <span class="stringliteral">&quot;/truncated.stl&quot;</span>;</div><div class="line"></div><div class="line">    <span class="keyword">delete</span> densityFile;</div><div class="line">    <span class="keyword">delete</span> shapeFile;</div><div class="line">    <span class="keyword">delete</span> meshFile;</div><div class="line">    <span class="keyword">delete</span> renderer;</div><div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 10 2017 12:07:23 for SSIMRenderer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
